<!DOCTYPE html>
<html>
<head>
    <title>Admin Dashboard - SOSL</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        h1 { color: #333; text-align: center; }
        .search-box { width: 300px; padding: 10px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #65c0ba; color: white; }
        tr:hover { background-color: #f5f5f5; }
        .btn { padding: 8px 15px; margin: 2px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-view { background: #007bff; color: white; }
        .btn-edit { background: #28a745; color: white; }
        .btn-delete { background: #dc3545; color: white; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 5% auto; padding: 20px; width: 80%; max-width: 600px; border-radius: 10px; }
        .close { float: right; font-size: 28px; cursor: pointer; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, textarea, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; }
        textarea { height: 80px; resize: vertical; }
        .stats { display: flex; gap: 20px; margin-bottom: 20px; }
        .stat-box { background: #65c0ba; color: white; padding: 20px; border-radius: 10px; text-align: center; flex: 1; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Secret of Sri Lanka - Admin Dashboard 
            <button onclick="logout()" style="float: right; background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">Logout</button>
        </h1>
        
        <!-- Statistics -->
        <div class="stats">
            <div class="stat-box">
                <h3 id="total-count">0</h3>
                <p>Total Inquiries</p>
            </div>
        </div>

        <!-- Search -->
        <input type="text" class="search-box" id="search" placeholder="Search by name..." onkeyup="searchTable()">
        
        <!-- Inquiries Table -->
        <table id="inquiriesTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <!-- Data will be loaded here -->
            </tbody>
        </table>
    </div>

    <!-- View Modal -->
    <div id="viewModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('viewModal')">&times;</span>
            <h2>View Inquiry</h2>
            <div id="viewContent"></div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editModal')">&times;</span>
            <h2>Edit Inquiry</h2>
            <form id="editForm">
                <input type="hidden" id="editId">
                <div class="form-group">
                    <label>Name:</label>
                    <input type="text" id="editName" required>
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="editEmail" required>
                </div>
                <div class="form-group">
                    <label>Phone:</label>
                    <input type="text" id="editPhone">
                </div>
                <div class="form-group">
                    <label>Message:</label>
                    <textarea id="editMessage" required></textarea>
                </div>
                <button type="submit" class="btn btn-edit">Save Changes</button>
            </form>
        </div>
    </div>

    <script>
        let inquiries = [];
        let currentId = null;

        window.onload = function() {
            checkLogin();
        };

        function checkLogin() {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', 'login.php?action=check_session', true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    if (xhr.responseText == 'logged_in') {
                        loadInquiries();
                    } else {
                        window.location.href = 'login.html';
                    }
                }
            };
            xhr.send();
        }

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                var xhr = new XMLHttpRequest();
                xhr.open('GET', 'login.php?action=logout', true);
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == 4 && xhr.status == 200) {
                        window.location.href = 'index.html';
                    }
                };
                xhr.send();
            }
        }

        // Load inquiries
        function loadInquiries() {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', 'admin.php?action=list', true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    inquiries = JSON.parse(xhr.responseText);
                    displayInquiries(inquiries);
                    updateStats();
                }
            };
            xhr.send();
        }

        // Display inquiries
        function displayInquiries(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            data.forEach(inquiry => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${inquiry.id}</td>
                    <td>${inquiry.name}</td>
                    <td>${inquiry.email}</td>
                    <td>${inquiry.phone_number || 'N/A'}</td>
                    <td>
                        <button class="btn btn-view" onclick="viewInquiry(${inquiry.id})">View</button>
                        <button class="btn btn-edit" onclick="editInquiry(${inquiry.id})">Edit</button>
                        <button class="btn btn-delete" onclick="deleteInquiry(${inquiry.id})">Delete</button>
                    </td>
                `;
            });
        }

        // Update statistics
        function updateStats() {
            const total = inquiries.length;
            document.getElementById('total-count').textContent = total;
        }

        // Search function
        function searchTable() {
            var searchTerm = document.getElementById('search').value.toLowerCase();
            var filtered = [];
            
            for (var i = 0; i < inquiries.length; i++) {
                var inquiry = inquiries[i];
                if (inquiry.name.toLowerCase().indexOf(searchTerm) !== -1) {
                    filtered.push(inquiry);
                }
            }
            
            displayInquiries(filtered);
        }

        // View inquiry
        function viewInquiry(id) {
            var inquiry = null;
            for (var i = 0; i < inquiries.length; i++) {
                if (inquiries[i].id == id) {
                    inquiry = inquiries[i];
                    break;
                }
            }
            
            currentId = id;
            
            document.getElementById('viewContent').innerHTML = 
                '<p><strong>Name:</strong> ' + inquiry.name + '</p>' +
                '<p><strong>Email:</strong> ' + inquiry.email + '</p>' +
                '<p><strong>Phone:</strong> ' + (inquiry.phone_number || 'N/A') + '</p>' +
                '<p><strong>Message:</strong></p>' +
                '<div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">' + inquiry.message + '</div>';
            
            document.getElementById('viewModal').style.display = 'block';
        }

        // Edit inquiry
        function editInquiry(id) {
            var inquiry = null;
            for (var i = 0; i < inquiries.length; i++) {
                if (inquiries[i].id == id) {
                    inquiry = inquiries[i];
                    break;
                }
            }
            
            document.getElementById('editId').value = inquiry.id;
            document.getElementById('editName').value = inquiry.name;
            document.getElementById('editEmail').value = inquiry.email;
            document.getElementById('editPhone').value = inquiry.phone_number || '';
            document.getElementById('editMessage').value = inquiry.message;
            
            document.getElementById('editModal').style.display = 'block';
        }

        // Delete inquiry
        function deleteInquiry(id) {
            if (confirm('Are you sure you want to delete this inquiry?')) {
                var xhr = new XMLHttpRequest();
                var formData = new FormData();
                formData.append('action', 'delete');
                formData.append('id', id);

                xhr.open('POST', 'admin.php', true);
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == 4 && xhr.status == 200) {
                        if (xhr.responseText == 'success') {
                            loadInquiries();
                            alert('Inquiry deleted successfully!');
                        } else {
                            alert('Error deleting inquiry');
                        }
                    }
                };
                xhr.send(formData);
            }
        }

        function markAsRead() {
            const formData = new FormData();
            formData.append('action', 'mark_read');
            formData.append('id', currentId);

            fetch('simple_admin_backend.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadInquiries();
                    closeModal('viewModal');
                }
            })
            .catch(error => console.error('Error:', error));
        }

        // Handle edit form submission
        document.getElementById('editForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            var xhr = new XMLHttpRequest();
            var formData = new FormData();
            formData.append('action', 'update');
            formData.append('id', document.getElementById('editId').value);
            formData.append('name', document.getElementById('editName').value);
            formData.append('email', document.getElementById('editEmail').value);
            formData.append('phone_num', document.getElementById('editPhone').value);
            formData.append('message', document.getElementById('editMessage').value);

            xhr.open('POST', 'admin.php', true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    if (xhr.responseText == 'success') {
                        loadInquiries();
                        closeModal('editModal');
                        alert('Inquiry updated successfully!');
                    } else {
                        alert('Error updating inquiry');
                    }
                }
            };
            xhr.send(formData);
        });

        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>